---
title: "Regresi√≥n Logistica y Regresi√≥n de Poisson"
author: "Kevin J. Paez"
format: html
editor: franks 
---

# **Integrantes:**

-   Yhosimar Ernesto, Surichaqui Sedano

-   Valerit Aracely, Castillo Delgado

-   Rosmery, Urpay De La Cruz

-   Katherine Alessandra, Siguas Aliaga

-   Franks Wilser, Chancos Pariguana

# Cargar e instalar paquetes

Cargar los 5 paquetes para proceder a la carga de datos de Rstudios.

```{r}
library(tidyverse)
library(here) 
library(rio) 
library(gtsummary) 
library(car) 
```

## Cargando los datos

```{r}
hipert_covid <- import(here("data", "s10_hipert_covid.csv"))
```

```{r}
asma <- import(here("data", "s10_asma.csv"))
```

## Sobre los datos para esta pr√°ctica

El dataset *hipert_covid* incluye informaci√≥n de 287 personas adultas diagnosticadas con COVID-19 y diabetes mellitus. Contiene datos sobre el desenlace al alta hospitalaria (vivo o fallecido), as√≠ como otras variables relevantes como edad, sexo, presencia de hipertensi√≥n, entre otras.

## Importante, antes de iniciar

La estimaci√≥n de asociaci√≥n entre variables para esta sesi√≥n es un an√°lisis univariado o no ajustado. En un estudio formal, tesis o art√≠culo cient√≠fico, que haga empleo de un an√°lisis de regresi√≥n log√≠stica o regresi√≥n de Poisson es necesario procedimientos adicionales, incluyendo la evaluaci√≥n del ajuste del modelo y el an√°lisis multivariado o ajustado. Lo √∫ltimo, lo veremos en una sesi√≥n posterior.

# 1 Regresi√≥n log√≠stica binaria

La regresi√≥n log√≠stica binaria es similar a la regresi√≥n lineal en el sentido de que modela un desenlace (variable dependiente) en funci√≥n de uno o m√°s predictores. Sin embargo, la principal diferencia es que en la regresi√≥n log√≠stica el desenlace debe ser dicot√≥mico: es decir, una variable que solo toma dos posibles valores. La regresi√≥n log√≠stica nos permite responder preguntas como:

-   ¬øCu√°l es la asociaci√≥n entre el estado de dengue hemorr√°gico (dengue hemorr√°gico vs. dengue no hemorr√°gico) y la edad?

-   ¬øExiste relaci√≥n entre el estado de mortalidad (vivo vs. fallecido) y la hipertensi√≥n en pacientes con COVID-19 y diabetes mellitus?

Al igual que en la regresi√≥n lineal, la regresi√≥n log√≠stica permite comprobar la hip√≥tesis nula (no hay asociaci√≥n), estimar la magnitud de la asociaci√≥n (usando Odds Ratio) y calcular su intervalo de confianza al 95%.

## 1.1 Aspectos b√°sicos para la interpretaci√≥n la regresi√≥n log√≠stica

¬øQu√© son los odds (posibilidades)?

Si ùëù es la probabilidad de que ocurra un evento (por ejemplo, muerte), entonces los odds (posibilidades) son el cociente ùëù/1‚àíùëù, es decir, la raz√≥n entre la probabilidad de que ocurra el evento y la probabilidad de que no ocurra. En medicina, com√∫nmente se trabaja con el logaritmo natural de los odds, conocido como log-odds o logit. Por ejemplo, si un evento tiene una probabilidad del 75%, sus odds son 0.75/0.25=3, lo que se lee como "3 a 1".

Otro ejemplo: en una reuni√≥n de cinco personas (incluy√©ndote), cada una escribe su nombre para un sorteo. Tu probabilidad de ganar es 1/5 = 0.20, pero los odds de ganar son 1 a 4 (0.25), porque hay un papel con tu nombre y cuatro sin √©l; una oportunidad de ganar y cuatro de perder.

Entonces, existe una relaci√≥n directa entre odds y probabilidad, pero expresan lo mismo en diferentes escalas. Los odds son mayores que 1 si, y solo si, la probabilidad es mayor que 0.5; son menores que 1 si la probabilidad es menor que 0.5; y son exactamente 1 cuando la probabilidad es 0.5.

En estudios con modelos de regresi√≥n log√≠stica para analizar asociaciones, reportamos los odds ratios (OR), que comparan los odds entre grupos.

¬øQu√© son los Odds Ratio (OR)?

Un *odds ratio* (OR) compara las *odds* (posibilidades) de que ocurra un evento entre dos grupos diferentes. Por ejemplo, supongamos que la probabilidad de enfermedad es 0.35 en hombres y 0.25 en mujeres. Entonces, el OR ser√≠a:

$$
\frac{0.35}{1 - 0.35} \div \frac{0.25}{1 - 0.25} = \frac{0.35}{0.65} \div \frac{0.25}{0.75} = 0.538 \div 0.333 = 1.62
$$

Un OR mayor que 1 (o menor que 1) implica una asociaci√≥n positiva (o negativa) entre un predictor continuo y el desenlace. Un OR de 1 implica que no hay asociaci√≥n. Finalmente, como lo mostrado aqu√≠, la medida de OR tiene direcci√≥n e intensidad. A esto lo conocemos como una medida de efecto. OR es una de las varias que son usadas para reportar estudios en epidemiolog√≠a.

## 1.1 El problema en este ejercicio

El desenlace de inter√©s para este ejercicio es la variable muerte (en el dataset, *desenlace*). Evaluaremos la relaci√≥n entre el estado de mortalidad e hipertensi√≥n entre pacientes que fueron diagnosticados con COVID-19 y diabetes mellitus.

## 1.2 Estimando OR usando regresi√≥n log√≠stica para un predictor categ√≥rico

Antes de estimar el OR usando regresi√≥n log√≠stica, debemos convertir la variable hipertensi√≥n a factor (variable categ√≥rica en R). Adem√°s, establecemos el nivel "no" como referencia, para as√≠ estimar el OR comparando pacientes con COVID-19 y diabetes mellitus que tienen hipertensi√≥n frente a aquellos sin hipertensi√≥n. Hacemos lo mismo con la variable desenlace, de modo que "vivo" sea la categor√≠a de referencia y "fallecido" sea considerado el evento.

```{r}
hipert_covid_1 <- hipert_covid |> 
  mutate(hipert = relevel(as.factor(hipert), ref = "no"),
         desenlace = relevel(as.factor(desenlace), ref = "vivo"))
```

A continuaci√≥n, usamos la funci√≥n `glm()`, general linear model, con el argumento family = binomial para ajustar una regresi√≥n log√≠stica y `summary()` para ver los resultados.

```{r}
regre_log <- glm(desenlace ~ hipert,
                 family = binomial, 
                 data = hipert_covid_1)

summary(regre_log)
```

El coeficiente de regresi√≥n para *hipertSi* (0.7444) representa el logaritmo del OR para fallecer, comparando pacientes hipertensos con pacientes no hipertensos.

Para obtener el OR en s√≠ (como usualmente se reporta en los estudios), exponenciamos el coeficiente usando la funci√≥n exp()

```{r}
exp(coef(regre_log)[-1]) # [-1] elimina la primera fila, al intercepto.
```

Usamos la funci√≥n `confint()` para calcular los intervalos de confianza (IC) al 95% para el coeficientes de regresi√≥n, y exponenciamos estos valores para obtener los IC del 95% para los OR.

```{r}
exp(confint(regre_log))[-1, , drop=F]
```

En este ejemplo, el predictor categ√≥rico ten√≠a solo dos niveles (Si y No), por lo que se obtiene el valor p que prueba su asociaci√≥n con el desenlace (fallecido) a partir de la tabla de coeficientes de la regresi√≥n (0.00298).

## 1.3 Interpretando los resultados

Los pacientes con COVID-19 y diabetes mellitus con hipertensi√≥n tienen significativamente mayores odds de fallecer en comparaci√≥n a paciente con COVID-19 y diabetes mellitus sin hipertensi√≥n (OR = 2.10; IC 95% = 1.2918, 3.4561; p = 0.00298). Espec√≠ficamente, tienen aproximadamente 110% m√°s odds de presentar el desenlace.

## 1.4 Estimando OR usando regresi√≥n log√≠stica para un predictor num√©rico

Usando el mismo dataset, la siguiente pregunta que intentaremos responder usando regresi√≥n log√≠stica es ¬øcu√°l es la asociaci√≥n entre la mortalidad y la edad en pacientes diagnosticados con COVID-19 y diabetes mellitus?

## 1.6 Ajustamos el modelo

```{r}
regre_log_1 <- glm(desenlace ~ edad, family = binomial, data = hipert_covid_1)

summary(regre_log_1)$coef
```

El coeficiente de regresi√≥n para la edad (0.0583) indica cu√°nto cambia el logaritmo de las odds del desenlace por cada aumento de un a√±o en la edad. Si convertimos esto a un OR exponenciandolos, obtenemos:

```{r}
exp(coef(regre_log_1)[-1])
```

Finalmente, calcula un intervalo de confianza del 95% para el OR usando `confint()` y exponenciando los resultados.

```{r}
exp(confint(regre_log_1)[-1,])
```

## 1.7 Interpretando el resultado

Entre los pacientes con COVID-19 y diabetes mellitus, la edad est√° significativamente asociada de forma positiva con el desenlace muerte (OR = 1.06; IC 95% = 1.04, 1.08; p\<0.05). Esto significa que por cada a√±o adicional de edad, las odds de muerte aumentan aproximadamente un 6%. Por ejemplo, una persona de 60 a√±os tiene un 6% m√°s de odds (posibilidaes) de morir que una persona de 59 a√±os.

## 1.8 C√≥mo reportar los resultados de una regresi√≥n log√≠stica para un reporte cient√≠fico.

Aqu√≠ usamos funciones que ya hemos empleado en sesiones anteriores. tbl_uvregression() es la funci√≥n que permite producir tablas con resultados de la regresi√≥n log√≠stica. Como argumento incluye el tipo de regresi√≥n, variables y otras especificaciones.

```{r}
theme_gtsummary_language(language = "es")
```

```{r}
tabla_reg_logi <- hipert_covid_1 |>
  tbl_uvregression(
    include = c(edad, sexo, hipert),
    y = desenlace,
    method = glm,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    conf.int = TRUE,
    hide_n = TRUE,
    add_estimate_to_reference_rows = FALSE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad ~ "Edad (a√±os)",
      sexo ~ "Sexo",
      hipert ~ "Hipertensi√≥n"
    )
  ) |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**OR no ajustado**", p.value = "**Valor P**")
```

Imprime la tabla

```{r}
tabla_reg_logi
```

## 2 Regresi√≥n de Poisson

La regresi√≥n de Poisson es un modelo de regresi√≥n para datos de conteo y de tasas. Al igual que el modelo de regresi√≥n log√≠stica, este es un tipo de modelo lineal generalizado que se usa cuando el desenlace (variable dependiente) es un conteo. Aunque los datos de conteo y tasas son muy comunes en medicina y ciencias de la salud, la regresi√≥n de Poisson est√° subutilizada en la investigaci√≥n m√©dica.

B√°sicamente, la regresi√≥n de Poisson modela la relaci√≥n lineal entre:

Desenlace: variable de conteo (por ejemplo, n√∫mero de hospitalizaciones, paridad, lesiones cancerosas, ataques asm√°ticos). Esta variable se transforma a escala de logaritmo natural.

Predictores/variables independientes: variables num√©ricas (por ejemplo, edad, presi√≥n arterial) y variables categ√≥ricas (por ejemplo, raza, g√©nero, nivel educativo).

Usando la regresi√≥n de poisson, podemos evaluar: La relaci√≥n entre el n√∫mero de ataques asm√°ticos en el √∫ltimo a√±o y los factores sociodemogr√°ficos.

En la secci√≥n anterior, reportamos como medida de efecto OR para la regresi√≥n log√≠stica. Para la regresi√≥n de Poisson, al tomar el exponente del coeficiente, obtenemos la raz√≥n de tasas (rate ratio, RR), tambi√©n conocida como raz√≥n de tasas de incidencia (incidence rate ratio, IRR).

## 2.1 Sobre los datos para esta pr√°ctica

El dataset asma incluye informaci√≥n de un grupo de 120 individuos. El dataset incluye 4 variables: - Sexo: Sexo de los sujetos (categ√≥rica) (hombre, mujer). - infec_resp_recu: Infecci√≥n respiratoria recurrente (categ√≥rica) (no, s√≠). - ghq12: Puntaje del Cuestionario General de Salud 12 (GHQ-12) sobre bienestar psicol√≥gico (num√©rica) (0 a 36). - episod_asma: N√∫mero de ataques asm√°ticos por a√±o (conteo).

## 2.2 El problema en este ejercicio

Usando regresi√≥n de Poisson evaluaremos la relaci√≥n entre el n√∫mero de ataques asm√°ticos (variable episod_asma) en el √∫ltimo a√±o y los factores sociodemogr√°ficos.

## 2.3 Ajustamos modelos de regresi√≥n de Poisson

Ahora, ajustamos modelos de regresi√≥n de Poisson para las 3 variables predictoras usando la funci√≥n glm(). Seguido a esto, usamos summary() para ver los resultados.

Para la variable sexo

```{r}
reg_poisson1 = glm(episod_asma ~ sexo, data = asma, family = "poisson")
summary(reg_poisson1)
```

Para la variable infec_resp_recur

```{r}
reg_poisson2 = glm(episod_asma ~ infec_resp_recur, data = asma, family = "poisson")
summary(reg_poisson2)
```

Para la variable ghq12

```{r}
reg_poisson2 = glm(episod_asma ~ ghq12, data = asma, family = "poisson")
summary(reg_poisson2)
```

A partir de los resultados que se muestran en la secci√≥n de Coefficients, todas las variables son importantes (estan relacionados con el n√∫mero de ataques de asma) con un P \< 0.05.

## 2.4 C√≥mo interpretar y reportar los resultados de una regresi√≥n de Poisson

Como en la secci√≥n anterior, usamos tbl_regression() para generar una tabla con los resultados. Aqu√≠, para la interpretaci√≥n, exponenciamos los coeficientes para obtener la raz√≥n de tasas de incidencia (IRR).

```{r}
tabla_reg_poisson <- asma |>
  tbl_uvregression(
    include = c(sexo, infec_resp_recur, ghq12),
    y = episod_asma,
    method = glm,
    method.args = list(family = poisson),
    exponentiate = TRUE,
    conf.int = TRUE,
    hide_n = TRUE,
    add_estimate_to_reference_rows = FALSE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      sexo ~ "Sexo",
      infec_resp_recur ~ "Infecci√≥n respiratoria recurrente",
      ghq12 ~ "Bienestar psicol√≥gico"
    )
  ) |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**IRR no ajustado**", p.value = "**Valor P**")
```

Imprime la tabla

```{r}
tabla_reg_poisson
```

Bas√°ndonos en esta tabla, podemos interpretar los resultados de la siguiente manera:

Ser del sexo femenino esta asociado a un menor riesgo de sufrir un ataque asm√°tico, con un IRR de 0.74 (IC 95%: 0.58, 0.94).

Aquellos con infecci√≥n respiratoria recurrente tienen un mayor riesgo de sufrir un ataque asm√°tico, con un IRR de 2.47 (IC 95%: 1.84, 3.26).

Un aumento de un punto en la puntuaci√≥n GHQ-12 (que evalua el bienestar psicol√≥gico) incrementa el riesgo de tener un ataque asm√°tico en 1.06 (IC 95%: 1.05, 1.06).
